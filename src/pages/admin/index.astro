---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";

const token = Astro.cookies.get("sb_access_token")?.value;
if (!token) return Astro.redirect("/admin/login");

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    auth: { persistSession: false },
    global: { headers: { Authorization: `Bearer ${token}` } },
  }
);

// Filtro por estado (?status=pending | done | all)
const url = new URL(Astro.request.url);
const status = url.searchParams.get("status") ?? "all";

let q = supabase
  .from("requests")
  .select("id,created_at,name,email,phone,type,contacted,contacted_at,notes,message")
  .order("created_at", { ascending: false });

if (status === "pending") q = q.eq("contacted", false);
if (status === "done") q = q.eq("contacted", true);

const { data: requests, error } = await q;
if (error) console.log(error);

const formatDate = (d: string) => new Date(d).toLocaleString();
---

<BaseLayout title="Admin — Solicitudes">
  <main class="mx-auto max-w-6xl px-4 py-14" data-filter={status}>
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold">Solicitudes</h1>
        <p class="mt-2 text-white/70">Contactos y presupuestos recibidos</p>

        <nav class="mt-4 flex flex-wrap gap-2">
          <a
            href="/admin?status=all"
            class={`cursor-pointer rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
              status === "all" ? "bg-white/10" : ""
            }`}
          >
            Todas
          </a>
          <a
            href="/admin?status=pending"
            class={`cursor-pointer rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
              status === "pending" ? "bg-white/10" : ""
            }`}
          >
            Pendientes
          </a>
          <a
            href="/admin?status=done"
            class={`cursor-pointer rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
              status === "done" ? "bg-white/10" : ""
            }`}
          >
            Contactadas
          </a>
        </nav>
      </div>

      <form method="POST" action="/api/logout">
        <button class="cursor-pointer rounded-xl border border-white/15 px-5 py-3 hover:bg-white/5" type="submit">
          Cerrar sesión
        </button>
      </form>
    </div>

    <div class="mt-8 grid gap-4">
      {requests?.length ? (
        requests.map((r) => (
          <article
            class="rounded-2xl border border-white/10 bg-white/[0.03] p-5"
            data-request-card
            data-id={r.id}
          >
            {/* Header */}
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <h2 class="text-lg font-semibold">{r.name}</h2>

                <span class="rounded-full bg-white/10 px-3 py-1 text-xs text-white/80">
                  {r.type}
                </span>

                <span
                  data-pill
                  class={`rounded-full px-3 py-1 text-xs ${
                    r.contacted
                      ? "bg-emerald-500/15 text-emerald-200"
                      : "bg-amber-500/15 text-amber-200"
                  }`}
                >
                  {r.contacted ? "✅ Contactado" : "⏳ Pendiente"}
                </span>
              </div>

              <div class="text-xs text-white/55">
                Recibido: <span class="text-white/75">{formatDate(r.created_at)}</span>
              </div>
            </div>

            {/* Body */}
            <div class="mt-4 grid gap-4 md:grid-cols-[1fr_320px]">
              {/* IZQ: info + mensaje */}
              <div class="min-w-0">
                <div class="rounded-xl border border-white/10 bg-black/10 p-4">
                  <h3 class="text-sm font-semibold text-white/85">Datos del cliente</h3>

                  <dl class="mt-3 grid gap-x-6 gap-y-2 text-sm sm:grid-cols-2">
                    <div class="flex gap-2">
                      <dt class="w-20 shrink-0 text-white/50">Nombre:</dt>
                      <dd class="text-white/85">{r.name}</dd>
                    </div>

                    <div class="flex gap-2">
                      <dt class="w-20 shrink-0 text-white/50">Tipo:</dt>
                      <dd class="text-white/85">{r.type}</dd>
                    </div>

                    <div class="flex gap-2 sm:col-span-2">
                      <dt class="w-20 shrink-0 text-white/50">Email:</dt>
                      <dd class="text-white/85 break-all">{r.email}</dd>
                    </div>

                    <div class="flex gap-2">
                      <dt class="w-20 shrink-0 text-white/50">Teléfono:</dt>
                      <dd class="text-white/85">{r.phone ?? "-"}</dd>
                    </div>

                    <div class="flex gap-2">
                      <dt class="w-20 shrink-0 text-white/50">Estado:</dt>
                      <dd class="text-white/85">{r.contacted ? "Contactado" : "Pendiente"}</dd>
                    </div>
                  </dl>
                </div>

                <div class="mt-3 rounded-xl border border-white/10 bg-black/10 p-4">
                  <h3 class="text-sm font-semibold text-white/85">Mensaje</h3>
                  <p class="mt-2 whitespace-pre-wrap text-sm leading-relaxed text-white/85">
                    {r.message}
                  </p>
                </div>
              </div>

              {/* DER: acciones */}
              <div class="w-full shrink-0">
                <div class="rounded-xl border border-white/10 bg-black/10 p-4">
                  <h3 class="text-sm font-semibold text-white/85">Acciones</h3>

                  <form
                    method="POST"
                    action="/api/requests/contacted"
                    class="mt-3"
                    data-ajax="contacted"
                    data-id={r.id}
                  >
                    <input type="hidden" name="id" value={r.id} />
                    <input type="hidden" name="contacted" value={(!r.contacted).toString()} />

                    <button
                      class={`cursor-pointer w-full rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
                        r.contacted ? "bg-emerald-500/10" : "bg-white/5"
                      }`}
                      type="submit"
                    >
                      {r.contacted ? "Marcar pendiente" : "Marcar contactado"}
                    </button>

                    <div class="mt-2 flex items-center justify-between gap-2">
                      <span class="text-xs text-white/60" data-status></span>
                      <span class="text-xs text-white/55" data-contacted-at>
                        {r.contacted_at ? `Contactado: ${formatDate(r.contacted_at)}` : ""}
                      </span>
                    </div>
                  </form>

                  <form
                    method="POST"
                    action="/api/requests/notes"
                    class="mt-4"
                    data-ajax="notes"
                    data-id={r.id}
                  >
                    <input type="hidden" name="id" value={r.id} />
                    <label class="mb-2 block text-xs text-white/60">Notas internas</label>

                    <textarea
                      name="notes"
                      rows="5"
                      class="w-full rounded-xl border border-white/10 bg-black/20 p-3 text-sm text-white/90 placeholder:text-white/40"
                      placeholder="Escribe notas para esta solicitud…"
                    >{r.notes ?? ""}</textarea>

                    <div class="mt-2 flex items-center justify-between gap-2">
                      <button
                        class="cursor-pointer rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5"
                        type="submit"
                      >
                        Guardar notas
                      </button>

                      <span class="text-xs text-white/60" data-status></span>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </article>
        ))
      ) : (
        <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-8 text-white/70">
          No hay solicitudes todavía.
        </div>
      )}
    </div>
  </main>

  <script is:inline>
    const CURRENT_FILTER =
      document.querySelector("main[data-filter]")?.dataset.filter || "all";

    function setStatus(form, text, ok = true) {
      const el = form.querySelector("[data-status]");
      if (!el) return;
      el.textContent = text;
      el.className = ok ? "text-xs text-emerald-200" : "text-xs text-red-200";
    }

    function getCard(form) {
      const id = form.dataset.id;
      if (!id) return null;
      return document.querySelector(`[data-request-card][data-id="${id}"]`);
    }

    function updatePill(card, contacted) {
      const pill = card?.querySelector("[data-pill]");
      if (!pill) return;
      pill.textContent = contacted ? "✅ Contactado" : "⏳ Pendiente";
      pill.className =
        "rounded-full px-3 py-1 text-xs " +
        (contacted
          ? "bg-emerald-500/15 text-emerald-200"
          : "bg-amber-500/15 text-amber-200");
    }

    function updateContactedAt(form, contacted) {
      const el = form.querySelector("[data-contacted-at]");
      if (!el) return;
      el.textContent = contacted ? "Contactado: " + new Date().toLocaleString() : "";
    }

    function shouldRemoveFromList(contacted) {
      if (CURRENT_FILTER === "pending") return contacted === true;
      if (CURRENT_FILTER === "done") return contacted === false;
      return false;
    }

    async function postForm(form) {
      const btn = form.querySelector("button[type='submit']");
      const prevText = btn ? btn.textContent : "";

      try {
        setStatus(form, "Guardando…", true);
        if (btn) {
          btn.disabled = true;
          btn.textContent = "Guardando…";
        }

        const res = await fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: { Accept: "text/plain" },
        });

        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(t || `HTTP ${res.status}`);
        }

        setStatus(form, "Guardado ✓", true);

        if (form.dataset.ajax === "contacted") {
          const contactedInput = form.querySelector("input[name='contacted']");
          const newContacted = contactedInput ? contactedInput.value === "true" : false;

          if (contactedInput) contactedInput.value = (!newContacted).toString();

          if (btn) {
            btn.textContent = newContacted ? "Marcar pendiente" : "Marcar contactado";
            btn.classList.toggle("bg-emerald-500/10", newContacted);
            btn.classList.toggle("bg-white/5", !newContacted);
          }

          const card = getCard(form);
          updatePill(card, newContacted);
          updateContactedAt(form, newContacted);

          if (card && shouldRemoveFromList(newContacted)) {
            card.style.opacity = "0.4";
            setTimeout(() => card.remove(), 150);
          }
        }
      } catch (e) {
        console.error(e);
        setStatus(form, "Error al guardar", false);
      } finally {
        if (btn) {
          btn.disabled = false;
          if (form.dataset.ajax !== "contacted") btn.textContent = prevText;
          if (form.dataset.ajax === "contacted" && btn.textContent === "Guardando…") {
            btn.textContent = prevText;
          }
        }
        setTimeout(() => setStatus(form, ""), 2000);
      }
    }

    document.addEventListener("submit", (ev) => {
      const form = ev.target;
      if (!(form instanceof HTMLFormElement)) return;
      if (!form.dataset.ajax) return;
      ev.preventDefault();
      postForm(form);
    });
  </script>
</BaseLayout>
