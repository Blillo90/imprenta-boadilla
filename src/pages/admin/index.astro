---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";

const token = Astro.cookies.get("sb_access_token")?.value;
if (!token) return Astro.redirect("/admin/login");

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    auth: { persistSession: false },
    global: { headers: { Authorization: `Bearer ${token}` } },
  }
);

// Filtro por estado (?status=pending | done | all)
const url = new URL(Astro.request.url);
const status = url.searchParams.get("status") ?? "all";

let q = supabase
  .from("requests")
  .select(
    "id,created_at,name,email,phone,type,source,contacted,contacted_at,notes,ip,user_agent,message"
  )
  .order("created_at", { ascending: false });

if (status === "pending") q = q.eq("contacted", false);
if (status === "done") q = q.eq("contacted", true);

const { data: requests, error } = await q;
if (error) console.log(error);
---

<BaseLayout title="Admin — Solicitudes">
  <main class="mx-auto max-w-6xl px-4 py-14">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold">Solicitudes</h1>
        <p class="mt-2 text-white/70">Contactos y presupuestos recibidos</p>

        <nav class="mt-4 flex flex-wrap gap-2">
          <a
            href="/admin?status=all"
            class={`rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
              status === "all" ? "bg-white/10" : ""
            }`}
          >
            Todas
          </a>
          <a
            href="/admin?status=pending"
            class={`rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
              status === "pending" ? "bg-white/10" : ""
            }`}
          >
            Pendientes
          </a>
          <a
            href="/admin?status=done"
            class={`rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
              status === "done" ? "bg-white/10" : ""
            }`}
          >
            Contactadas
          </a>
        </nav>
      </div>

      <form method="POST" action="/api/logout">
        <button class="rounded-xl border border-white/15 px-5 py-3 hover:bg-white/5" type="submit">
          Cerrar sesión
        </button>
      </form>
    </div>

    <div class="mt-8 grid gap-4">
      {requests?.length ? (
        requests.map((r) => (
          <article class="rounded-2xl border border-white/10 bg-white/[0.03] p-5" data-request-card data-id={r.id}>
            <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
              <div class="min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <h2 class="text-lg font-semibold">{r.name}</h2>
                  <span class="rounded-full bg-white/10 px-3 py-1 text-xs text-white/80">
                    {r.type}
                  </span>

                  <span
                    data-pill
                    class={`rounded-full px-3 py-1 text-xs ${
                      r.contacted
                        ? "bg-emerald-500/15 text-emerald-200"
                        : "bg-amber-500/15 text-amber-200"
                    }`}
                  >
                    {r.contacted ? "✅ Contactado" : "⏳ Pendiente"}
                  </span>
                </div>

                <div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-sm text-white/75">
                  <span>{r.email}</span>
                  <span>{r.phone ?? "-"}</span>
                  <span class="text-white/60">{new Date(r.created_at).toLocaleString()}</span>
                </div>

                <p class="mt-3 whitespace-pre-wrap text-sm leading-relaxed text-white/85">
                  {r.message}
                </p>

                <div class="mt-3 text-xs text-white/55">
                  {r.ip ? <span>IP: {r.ip}</span> : <span>IP: -</span>}
                  <span class="mx-2">·</span>
                  <span>
                    UA: {r.user_agent ? String(r.user_agent).slice(0, 80) : "-"}
                    {r.user_agent && String(r.user_agent).length > 80 ? "…" : ""}
                  </span>
                </div>
              </div>

              <div class="w-full md:w-[320px] shrink-0">
                <form
                  method="POST"
                  action="/api/requests/contacted"
                  class="flex items-center gap-2"
                  data-ajax="contacted"
                  data-id={r.id}
                >
                  <input type="hidden" name="id" value={r.id} />
                  <input type="hidden" name="contacted" value={(!r.contacted).toString()} />
                  <button
                    class={`w-full rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5 ${
                      r.contacted ? "bg-emerald-500/10" : "bg-white/5"
                    }`}
                    type="submit"
                  >
                    {r.contacted ? "Marcar pendiente" : "Marcar contactado"}
                  </button>
                  <span class="text-xs text-white/60" data-status></span>
                </form>

                <form
                  method="POST"
                  action="/api/requests/notes"
                  class="mt-3"
                  data-ajax="notes"
                  data-id={r.id}
                >
                  <input type="hidden" name="id" value={r.id} />
                  <label class="block text-xs text-white/60 mb-2">Notas internas</label>
                  <textarea
                    name="notes"
                    rows="4"
                    class="w-full rounded-xl border border-white/10 bg-black/20 p-3 text-sm text-white/90 placeholder:text-white/40"
                    placeholder="Escribe notas para esta solicitud…"
                  >{r.notes ?? ""}</textarea>

                  <div class="mt-2 flex items-center justify-between gap-2">
                    <button
                      class="rounded-xl border border-white/15 px-4 py-2 text-sm hover:bg-white/5"
                      type="submit"
                    >
                      Guardar notas
                    </button>

                    <span class="text-xs text-white/60" data-status></span>

                    {r.contacted_at ? (
                      <span class="text-xs text-white/55" data-contacted-at>
                        Contactado: {new Date(r.contacted_at).toLocaleString()}
                      </span>
                    ) : (
                      <span class="text-xs text-white/55" data-contacted-at></span>
                    )}
                  </div>
                </form>
              </div>
            </div>
          </article>
        ))
      ) : (
        <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-8 text-white/70">
          No hay solicitudes todavía.
        </div>
      )}
    </div>
  </main>

  <script is:inline>
    const CURRENT_FILTER =
      document.querySelector("main[data-filter]")?.dataset.filter || "all";

    function setStatus(form, text, ok = true) {
      const el = form.querySelector("[data-status]");
     if (!el) return;
      el.textContent = text;
      el.className = ok ? "text-xs text-emerald-200" : "text-xs text-red-200";
   }

    function getCard(form) {
      const id = form.dataset.id;
      if (!id) return null;
      return document.querySelector(`[data-request-card][data-id="${id}"]`);
    }

    function updatePill(card, contacted) {
      const pill = card?.querySelector("[data-pill]");
      if (!pill) return;
      pill.textContent = contacted ? "✅ Contactado" : "⏳ Pendiente";
      pill.className =
        "rounded-full px-3 py-1 text-xs " +
        (contacted
          ? "bg-emerald-500/15 text-emerald-200"
          : "bg-amber-500/15 text-amber-200");
    }

    function updateContactedAt(card, contacted) {
      const el = card?.querySelector("[data-contacted-at]");
      if (!el) return;
      if (!contacted) {
        el.textContent = "";
        return;
      }
      // Mostramos "ahora" en UI (la DB guarda ISO exacto)
      el.textContent = "Contactado: " + new Date().toLocaleString();
    }

    function shouldRemoveFromList(contacted) {
      if (CURRENT_FILTER === "pending") return contacted === true;
      if (CURRENT_FILTER === "done") return contacted === false;
      return false;
    }

    async function postForm(form) {
      const btn = form.querySelector("button[type='submit']");
      const prevText = btn ? btn.textContent : "";

      try {
        setStatus(form, "Guardando…", true);
        if (btn) {
          btn.disabled = true;
          btn.textContent = "Guardando…";
        }

        const res = await fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: { Accept: "text/plain" },
        });

        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(t || `HTTP ${res.status}`);
        }

        setStatus(form, "Guardado ✓", true);

        if (form.dataset.ajax === "contacted") {
          const contactedInput = form.querySelector("input[name='contacted']");
          const newContacted = contactedInput ? contactedInput.value === "true" : false;

          // preparar siguiente toggle
          if (contactedInput) contactedInput.value = (!newContacted).toString();

          // actualizar botón
          if (btn) {
            btn.textContent = newContacted ? "Marcar pendiente" : "Marcar contactado";
            btn.classList.toggle("bg-emerald-500/10", newContacted);
            btn.classList.toggle("bg-white/5", !newContacted);
          }

          // actualizar pill + contacted_at en la card
          const card = getCard(form);
          updatePill(card, newContacted);
          updateContactedAt(card, newContacted);

          // si hay filtro activo, quitar la card si ya no encaja
          if (card && shouldRemoveFromList(newContacted)) {
            card.style.opacity = "0.4";
            setTimeout(() => card.remove(), 150);
          }
        }
      } catch (e) {
        console.error(e);
        setStatus(form, "Error al guardar", false);
      } finally {
        if (btn) {
          btn.disabled = false;
          // si era notes, volvemos al texto original
          if (form.dataset.ajax !== "contacted") btn.textContent = prevText;
          // si era contacted, el texto ya lo actualizamos arriba
          if (form.dataset.ajax === "contacted" && btn.textContent === "Guardando…") {
            btn.textContent = prevText;
          }
        }
        setTimeout(() => setStatus(form, ""), 2000);
      }
    }

    document.addEventListener("submit", (ev) => {
      const form = ev.target;
      if (!(form instanceof HTMLFormElement)) return;
      if (!form.dataset.ajax) return;
      ev.preventDefault();
      postForm(form);
    });
  </script>
</BaseLayout>
