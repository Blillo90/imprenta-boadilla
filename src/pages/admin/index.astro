---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";

const token = Astro.cookies.get("sb_access_token")?.value;
if (!token) return Astro.redirect("/admin/login");

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    auth: { persistSession: false },
    global: { headers: { Authorization: `Bearer ${token}` } },
  }
);

const { data: requests, error } = await supabase
  .from("requests")
  .select("id,created_at,name,email,phone,type,status,contacted,message")
  .order("created_at", { ascending: false });

if (error) console.log(error);
---

<BaseLayout title="Admin — Solicitudes">
  <main class="mx-auto max-w-6xl px-4 py-14">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold">Solicitudes</h1>
        <p class="mt-2 text-white/70">Contactos y presupuestos recibidos</p>
      </div>
      <form method="POST" action="/api/logout">
        <button class="rounded-xl border border-white/15 px-5 py-3 hover:bg-white/5" type="submit">
          Cerrar sesión
        </button>
      </form>
    </div>

    <div class="mt-8 overflow-x-auto rounded-2xl border border-white/10">
      <table class="min-w-full text-sm">
        <thead class="bg-white/5 text-white/80">
          <tr>
            <th class="px-4 py-3 text-left">Fecha</th>
            <th class="px-4 py-3 text-left">Nombre</th>
            <th class="px-4 py-3 text-left">Email</th>
            <th class="px-4 py-3 text-left">Tel</th>
            <th class="px-4 py-3 text-left">Tipo</th>
            <th class="px-4 py-3 text-left">Estado</th>
            <th class="px-4 py-3 text-left">Mensaje</th>
          </tr>
        </thead>
        <tbody>
          {requests?.map((r) => (
            <tr class="border-t border-white/10">
              <td class="px-4 py-3 whitespace-nowrap text-white/70">
                {new Date(r.created_at).toLocaleString()}
              </td>
              <td class="px-4 py-3">{r.name}</td>
              <td class="px-4 py-3 text-white/80">{r.email}</td>
              <td class="px-4 py-3 text-white/80">{r.phone ?? "-"}</td>
              <td class="px-4 py-3">{r.type}</td>
              <td class="px-4 py-3">{r.status}</td>
              <td class="px-4 py-3 max-w-[420px] text-white/80">
                <span class="line-clamp-2">{r.message}</span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </main>
</BaseLayout>
